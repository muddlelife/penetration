# 渗透测试

> 本文只是渗透测试过程中的思路总结。具体的方法、步骤以后会总结
>
> ps：渗透测试并不能使网络更安全

## 渗透测试方法

* 黑盒测试

  假定渗透测试人员先期对目标网络、公司流程或应用提供的服务没有了解。启动黑盒测试项目需要做大量的侦察，而且还需要长期跟踪

* 白盒测试

  白盒测试是当渗透测试人员对系统非常熟悉时采用的方法。白盒渗透测试的目标是明确定义好的，而测试报告的结果通常是有预期的。测试人员会接触目标的详细信息，如网络信息、系统类型、公司流程和服务等，白盒测试任务可以降低信息收集的成本

* 灰盒测试

  灰盒测试介于黑盒和白盒测试之间。它通常出现的情况是，客户或系统所有者同意：在侦察环节中最终会发现一些不确定信息，但渗透测试人员可以忽略这部分信息。渗透测试人员会知道目标的一些基本情况；不过，系统内部工作原理和其他一些受限信息仍然不会公开给渗透测试人员

## 基本流程

1. 信息收集（IP，端口，服务，版本，操作系统，框架，语言，后台，路径等）
2. 漏洞挖掘或者漏洞发现
3. 漏洞利用
4. 提权
5. 留后门
6. 渗透测试报告

### 信息收集

> 越是安静，侦察的收获就越多

* 收集域名信息

  whois查询、备案查询、在线网站

* 收集子域名信息

  在线平台、Google hacking、Fofa语法、工具枚举Layer、oneforall

* 查找真实IP

  判断是否存在CDN、全国ping、全球ping

* 常见端口扫描

  nmap、masscan、御剑高速端口扫描

  ```shell
  nmap -sn 192.168.216.0/24  # 做主机发现，不做端口扫描，用在网段里面
  netdiscover -i eth0 -r 192.168.216.5.0/24  # 主动模式
  netdiscover -p  # 在这个网段上监听，等对方，被动模式
  arpping 192.168.1.2  # 请求包
  
  masscan --rate=10000 --ports 0-65535 192.168.216.191  # 扫ip地址的端口
  nmap -T4 -sV -O -p 23,8080,80 192.168.191  # T4 速度 -sV 版本 —O 操作系统 -p端口 扫对应端口开放的服务
  ```

* CMS指纹识别

  whatweb、云悉

  ```shell
  whatweb http://192.168.216.191  # http
  ```

* WAF识别

  wafw00f

* 网站目录扫描

  dirb、御剑、dirbuster

  ```shell
  dirb http://192.168.216.191  # 如果扫不到，可以跟大字典
  ```

  记住，如果扫到了robots.txt，那么把robots.txt下面的disallow路径都访问一遍，因为搜索引擎默认不会爬取disallow路径

* 操作系统、版本、端口对应的服务、网站服务框架、服务版本

  如果知道了操作系统版本、框架、服务版本等东西，可以通过searchsploit 、msf、https://www.exploit-db.com找对应版本的漏洞，作为漏洞挖掘的杀手锏

* 制作有针对性的字典，收集用户的个人信息

  cewl

  ```shell
  cewl http://192.168.216.200 -w /tmp/passwd.txt --depth 3  # -w 将字典存为文件 --depth 3 爬取深度
  ```

* 常见框架的一些要点

  ```shell
  wordpress  # 默认后台 wp-login.php  # 可以用wpscan来扫是否存在漏洞
  wpscan http://192.168.216.200  # 整体扫
  wpscan --url http://192.168.216.200 -e u,vp,vt,tt  # -e 枚举 u 用户名 vp 漏洞插件 vt 漏洞主题 tt 缩略图
  ```


**这些信息收集完最好都记录下来，收集的信息越多，渗透成功的概率就越大**

### 漏洞挖掘

> 通过信息收集后，利用获取到的信息，开始寻找漏洞，并进行漏洞验证，并且需要找到所有能发现的漏洞，而不是仅仅一个而已

#### 利用工具

* 针对端口服务

  ssh服务：尝试连接，弱口令，爆破等，可以用针对服务版本用msf等

* 针对后台

  后台登录页面（包括数据库等）：弱口令，爆破，万能密码等

* 针对web网站

  浏览网页，发现常见web漏洞，还有知道web服务器支持的语言，如php、python等

  常见web漏洞

  ```txt
  SQL注入
  XSS跨站脚本
  CSRF跨站请求伪造
  文件包含漏洞
  文件上传漏洞
  文件解析漏洞
  远程代码执行漏洞
  逻辑漏洞
  目录遍历漏洞
  明文密码传输
  Java反序列化漏洞
  ```

* 针对中间件、框架、版本、服务等

  * 常见中间件IIS、Apache、Nginx、weblogic等
  * 框架漏洞 wordpress、drupal等
  * CVE漏洞

* 可以利用searchsploit 、msf、https://www.exploit-db.com、GitHub等方式进行Poc

* 用工具直接扫

  * Nessus：漏洞扫描工具，针对的是一个ip地址
  * AWVS：漏洞扫描工具，自动扫描互联网或者本地局域网中是否存在漏洞，并报告漏洞
  * AppScan：针对web应用程序的安全漏洞进行测试

### 漏洞利用

> 通过信息收集、漏洞挖掘两步，已经掌握了存在漏洞的地方，接下来对漏洞进行利用，获得webshell（主要是web端）

* SQL注入

  sqlmap 读取数据库文件，账号，密码等，也可以采用手工注入的方式

* XSS跨站脚本

  盗取cookie

* 文件上传

  上传一句话木马，利用菜刀，蚁剑连接，获得webshell

* 文件解析

  结合文件上传一起用，尝试反弹shell

* 中间件、框架、版本、服务等漏洞

  执行exp，获得shell

### 提权

> 经过漏洞利用后我们都会获得一个shell，有可能shell权限比较低，因此我们需要提权，鉴于服务器的操作系统一般都是Windows、Linux的，因此提权要根据操作系统来分别

* Linux

  > 得到webshell后基本命令

  ```shell
  uname -a  # 查看操作系统版本
  cat /etc/passwd  # 查看密码
  cat /etc/issue  # 查看当前版本
  pwd  # 查看当前路径
  whoami  # 查看当前用户
  lsb_release -a  # 查看内核版本
  groups  # 查看用户所属组
  sudo -l  # 查看执行的root权限的命令
  python -c 'import pty;pty.spawn("/bin/bahs")'  # 尝试重开一个新的终端
  ```

  > 常见提权方式

  * suid提权
  * 脏牛提权
  * rbash绕过

* Windows

  > 得到webshell后基本命令

  ```powershell
  
  ```

  > 进行域渗透

  > 常见提权方式

  * fgdump 抓取Windows用户密码
  * mimikatz 抓取Windows用户密码，并解密

### 留后门，清理日志文件

> 在拿到目标主机的最高权限，很可能当时我们并不能获取到想要的东西，需要长期的潜伏，进行信息收集。因此需要权限维持，而且不能被管理员所发现，因此需要留后门和清理日志文件

### 编写渗透测试报告

> 在完成渗透测试之后，需要编写渗透测试报告，报告内容就是我们之前发现的漏洞和漏洞风险问题，以及漏洞修补的方法

